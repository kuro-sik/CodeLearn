{"version":3,"sources":["../../../../src/components/FocusTrap/FocusTrap.tsx"],"sourcesContent":["import { type AllHTMLAttributes, type RefObject, useRef, useState } from 'react';\nimport { arraysEquals } from '../../helpers/array';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { useMutationObserver } from '../../hooks/useMutationObserver';\nimport { useStableCallback } from '../../hooks/useStableCallback';\nimport { FOCUSABLE_ELEMENTS_LIST, Keys, pressedKey } from '../../lib/accessibility';\nimport {\n  contains,\n  getActiveElementByAnotherElement,\n  getWindow,\n  isHTMLElement,\n  useDOM,\n} from '../../lib/dom';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport type { HasComponent, HasRootRef } from '../../types';\n\nconst FOCUSABLE_ELEMENTS: string = FOCUSABLE_ELEMENTS_LIST.join();\n\nconst useRestoreFocus = ({\n  restoreFocus,\n  timeout,\n  mount,\n  ref,\n}: Pick<FocusTrapProps, 'restoreFocus' | 'timeout' | 'mount'> & {\n  ref: RefObject<HTMLElement | null>;\n}) => {\n  const restoreFocusRef = useRef(restoreFocus);\n  restoreFocusRef.current = restoreFocus;\n  const [restoreFocusTo, setRestoreFocusTo] = useState<Element | null>(null);\n\n  const restoreFocusImpl = useStableCallback(() => {\n    const shouldRestoreFocus =\n      typeof restoreFocusRef.current === 'function'\n        ? restoreFocusRef.current()\n        : restoreFocusRef.current;\n\n    if (!shouldRestoreFocus) {\n      return;\n    }\n\n    setTimeout(() => {\n      const restoreFocusElement =\n        (isHTMLElement(shouldRestoreFocus) && shouldRestoreFocus) ||\n        (isHTMLElement(restoreFocusTo) && restoreFocusTo) ||\n        null;\n\n      if (restoreFocusElement) {\n        restoreFocusElement.focus();\n        setRestoreFocusTo(null);\n      }\n    }, timeout);\n  });\n\n  useIsomorphicLayoutEffect(\n    function calculateRestoreFocusTo() {\n      if (!ref.current || !restoreFocusRef.current || !mount) {\n        setRestoreFocusTo(null);\n        return;\n      }\n      setRestoreFocusTo(getActiveElementByAnotherElement(ref.current));\n    },\n    [ref, mount],\n  );\n\n  useIsomorphicLayoutEffect(\n    function tryToRestoreFocusOnUnmount() {\n      return () => {\n        restoreFocusImpl();\n      };\n    },\n    [restoreFocusImpl],\n  );\n\n  useIsomorphicLayoutEffect(\n    function tryToRestoreFocusWhenFakeUnmount() {\n      if (!mount) {\n        restoreFocusImpl();\n      }\n    },\n    [mount, restoreFocusImpl],\n  );\n};\n\nexport interface FocusTrapProps<T extends HTMLElement = HTMLElement>\n  extends Omit<AllHTMLAttributes<T>, 'autoFocus'>,\n    HasRootRef<T>,\n    HasComponent {\n  autoFocus?: boolean | 'root';\n  restoreFocus?: boolean | (() => boolean | HTMLElement);\n  mount?: boolean;\n  timeout?: number;\n  onClose?: () => void;\n  /**\n   * Форсированное отключение захвата фокуса\n   */\n  disabled?: boolean;\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/FocusTrap\n */\nexport const FocusTrap = <T extends HTMLElement = HTMLElement>({\n  Component = 'div',\n  onClose,\n  autoFocus = true,\n  restoreFocus = true,\n  disabled = false,\n  mount = true,\n  timeout = 0,\n  getRootRef,\n  children,\n  ...restProps\n}: FocusTrapProps<T>): React.ReactNode => {\n  const ref = useExternRef<T>(getRootRef);\n  const { document } = useDOM();\n\n  const focusableNodesRef = useRef<HTMLElement[]>([]);\n\n  useRestoreFocus({\n    restoreFocus,\n    timeout,\n    mount,\n    ref,\n  });\n\n  const focusNodeByIndex = (nodeIndex: number) => {\n    const element = focusableNodesRef.current[nodeIndex];\n\n    if (element) {\n      element.focus({\n        preventScroll: true,\n      });\n    }\n  };\n\n  const recalculateFocusableNodesRef = (parentNode: HTMLElement) => {\n    // eslint-disable-next-line no-restricted-properties\n    const newFocusableElements = parentNode.querySelectorAll<HTMLElement>(FOCUSABLE_ELEMENTS);\n\n    const nodes: HTMLElement[] = [];\n    newFocusableElements.forEach((focusableEl) => {\n      const { display, visibility } = getComputedStyle(focusableEl);\n      if (display !== 'none' && visibility !== 'hidden') {\n        nodes.push(focusableEl);\n      }\n    });\n    if (nodes.length === 0) {\n      // Чтобы фокус был хотя бы на родителе\n      nodes.push(parentNode);\n    }\n    focusableNodesRef.current = nodes;\n  };\n\n  const onMutateParentHandler = (parentNode: HTMLElement) => {\n    const oldFocusableNodes = [...focusableNodesRef.current];\n\n    recalculateFocusableNodesRef(parentNode);\n\n    if (!autoFocus || arraysEquals(oldFocusableNodes, focusableNodesRef.current)) {\n      return;\n    }\n\n    if (document) {\n      const activeElement = document.activeElement as HTMLElement;\n      const currentElementIndex = Math.max(\n        document.activeElement ? focusableNodesRef.current.indexOf(activeElement) : -1,\n        0,\n      );\n      focusNodeByIndex(currentElementIndex);\n    }\n  };\n\n  useMutationObserver(ref, () => ref.current && onMutateParentHandler(ref.current));\n\n  useIsomorphicLayoutEffect(() => {\n    ref.current && recalculateFocusableNodesRef(ref.current);\n  }, [ref]);\n\n  useIsomorphicLayoutEffect(\n    function tryToAutoFocusToFirstNode() {\n      if (!ref.current || !autoFocus || disabled) {\n        return;\n      }\n\n      const autoFocusToNode = () => {\n        if (!ref.current || !focusableNodesRef.current.length) {\n          return;\n        }\n        const activeElement = getActiveElementByAnotherElement(ref.current);\n        if (!contains(ref.current, activeElement)) {\n          if (autoFocus === 'root') {\n            ref.current?.focus();\n          } else {\n            focusableNodesRef.current[0].focus();\n          }\n        }\n      };\n      const timeoutId = setTimeout(autoFocusToNode, timeout);\n      return () => {\n        clearTimeout(timeoutId);\n      };\n    },\n    [autoFocus, timeout, disabled],\n  );\n\n  useIsomorphicLayoutEffect(() => {\n    if (!ref.current) {\n      return;\n    }\n\n    const onDocumentKeydown = (event: KeyboardEvent) => {\n      if (disabled) {\n        return;\n      }\n\n      const pressedKeyResult = pressedKey(event);\n\n      switch (pressedKeyResult) {\n        case Keys.TAB: {\n          if (!focusableNodesRef.current.length) {\n            return false;\n          }\n\n          const lastIdx = focusableNodesRef.current.length - 1;\n          const targetIdx = focusableNodesRef.current.findIndex((node) => node === event.target);\n\n          const shouldFocusFirstNode =\n            targetIdx === -1 || (targetIdx === lastIdx && !event.shiftKey);\n\n          if (shouldFocusFirstNode || (targetIdx === 0 && event.shiftKey)) {\n            event.preventDefault();\n\n            const node = focusableNodesRef.current[shouldFocusFirstNode ? 0 : lastIdx];\n\n            if (node !== getActiveElementByAnotherElement(node)) {\n              node.focus();\n            }\n\n            return false;\n          }\n\n          break;\n        }\n        case Keys.ESCAPE: {\n          if (onClose) {\n            event.preventDefault();\n            onClose();\n          }\n        }\n      }\n\n      return true;\n    };\n\n    const doc = getWindow(ref.current).document;\n    doc.addEventListener('keydown', onDocumentKeydown, {\n      capture: true,\n    });\n    return () => {\n      doc.removeEventListener('keydown', onDocumentKeydown, true);\n    };\n  }, [onClose, ref, disabled]);\n\n  return (\n    <Component tabIndex={-1} ref={ref} {...restProps}>\n      {children}\n    </Component>\n  );\n};\n"],"names":["FocusTrap","FOCUSABLE_ELEMENTS","FOCUSABLE_ELEMENTS_LIST","join","useRestoreFocus","restoreFocus","timeout","mount","ref","restoreFocusRef","useRef","current","restoreFocusTo","setRestoreFocusTo","useState","restoreFocusImpl","useStableCallback","shouldRestoreFocus","setTimeout","restoreFocusElement","isHTMLElement","focus","useIsomorphicLayoutEffect","calculateRestoreFocusTo","getActiveElementByAnotherElement","tryToRestoreFocusOnUnmount","tryToRestoreFocusWhenFakeUnmount","Component","onClose","autoFocus","disabled","getRootRef","children","restProps","useExternRef","document","useDOM","focusableNodesRef","focusNodeByIndex","nodeIndex","element","preventScroll","recalculateFocusableNodesRef","parentNode","newFocusableElements","querySelectorAll","nodes","forEach","focusableEl","display","visibility","getComputedStyle","push","length","onMutateParentHandler","oldFocusableNodes","arraysEquals","activeElement","currentElementIndex","Math","max","indexOf","useMutationObserver","tryToAutoFocusToFirstNode","autoFocusToNode","contains","timeoutId","clearTimeout","onDocumentKeydown","event","pressedKeyResult","pressedKey","Keys","TAB","lastIdx","targetIdx","findIndex","node","target","shouldFocusFirstNode","shiftKey","preventDefault","ESCAPE","doc","getWindow","addEventListener","capture","removeEventListener","tabIndex"],"mappings":"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"}